#!/bin/sh
# PCP QA Test No. 1139
# Ranking and predicates pmrep.
#
# Copyright (c) 2018 Red Hat.
#

seq=`basename $0`
echo "QA output created by $seq"

. ./common.python

$python -c "from pcp import pmapi" >/dev/null 2>&1
[ $? -eq 0 ] || _notrun "python pcp pmapi module not installed"
$python -c "from collections import OrderedDict" >/dev/null 2>&1
[ $? -eq 0 ] || _notrun "python collections OrderedDict module not installed"

which pmrep >/dev/null 2>&1 || _notrun "pmrep not installed"

status=1        # failure is the default!
hostname=`hostname`
$sudo rm -rf $tmp $tmp.* $seq.full
trap "cd $here; rm -rf $tmp.*; exit \$status" 0 1 2 3 15

_msg_filter()
{
    sed \
       -e "s,Recording .* metrics.*,Recording metrics...,g" \
    #end
}

log="--archive $here/archives/rank-pred -z"
out="-o archive -F $tmp.archive"

# real QA test starts here
echo "== test ranking"
pmrep -s  7 $log -p -r -u -J  2 disk.dev.read mem.util.used
pmrep -s  7 $log -p -r -u -J -3 disk.dev.read kernel.pernode.cpu.user

echo "== test predicate"
pmrep -s 15 $log -p -r -u -J  2 -N disk.dev.read disk.dev.read disk.dev.write mem.util.used
pmrep -s 15 $log -p -r -u -J  1 -N disk.dev.read,kernel.pernode.cpu.sys disk.dev.read disk.dev.write mem.util.used kernel.pernode.cpu.user kernel.pernode.cpu.sys

echo "== test instance filter, live filter, invert filter, ranking, predicate"
pmrep -s 15 $log $out -p -r -u                       disk.dev.read disk.dev.write | \
_msg_filter
pmrep -z -a $tmp.archive -p -r -u disk
rm -f $tmp.archive.0 $tmp.archive.index $tmp.archive.meta
pmrep -z -s 15 $log $out -p -r -u -J  2                 disk.dev.read disk.dev.write | \
_msg_filter
pmrep -z -a $tmp.archive -p -r -u disk
rm -f $tmp.archive.0 $tmp.archive.index $tmp.archive.meta
pmrep -z -s 15 $log $out -p -r -u -J  2 -i sda          disk.dev.read disk.dev.write | \
_msg_filter
pmrep -z -a $tmp.archive -p -r -u disk
rm -f $tmp.archive.0 $tmp.archive.index $tmp.archive.meta
pmrep -z -s 15 $log $out -p -r -u -J  2 -i sda -j       disk.dev.read disk.dev.write | \
_msg_filter
pmrep -z -a $tmp.archive -p -r -u disk
rm -f $tmp.archive.0 $tmp.archive.index $tmp.archive.meta
pmrep -z -s 15 $log $out -p -r -u -J  2 -i sda -j -n    disk.dev.read disk.dev.write | \
_msg_filter
pmrep -z -a $tmp.archive -p -r -u disk
rm -f $tmp.archive.0 $tmp.archive.index $tmp.archive.meta
pmrep -z -s 15 $log $out -p -r -u -J  2 -i sda -j -n -N disk.dev.read disk.dev.read disk.dev.write | \
_msg_filter
pmrep -z -a $tmp.archive -p -r -u disk
rm -f $tmp.archive.0 $tmp.archive.index $tmp.archive.meta
pmrep -z -s 15 $log $out -p -r -u -J  2           -n -N disk.dev.read disk.dev.read disk.dev.write | \
_msg_filter
pmrep -z -a $tmp.archive -p -r -u disk
rm -f $tmp.archive.0 $tmp.archive.index $tmp.archive.meta
pmrep -z -s 15 $log $out -p -r -u -J  2              -N disk.dev.read disk.dev.read disk.dev.write | \
_msg_filter
pmrep -z -a $tmp.archive -p -r -u disk
rm -f $tmp.archive.0 $tmp.archive.index $tmp.archive.meta

# success, all done
status=0
exit
